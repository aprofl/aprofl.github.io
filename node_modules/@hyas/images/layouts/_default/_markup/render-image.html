{{ $renderHookName := "image" }}
{{ $minHugoVersion := "0.114.0" }}
{{ if lt hugo.Version $minHugoVersion }}
  {{ errorf "The %q render hook requires Hugo v%s or later." $renderHookName $minHugoVersion }}
{{ end }}
{{ $errorLevel := or site.Params.render_hooks.image.errorLevel "ignore" | lower }}
{{ if not (in (slice "ignore" "warning" "error") $errorLevel) }}
  {{ errorf "The %q render hook is misconfigured. The errorLevel %q is invalid. Please check your site configuration." $renderHookName $errorLevel }}
{{ end }}
{{ $contentPath := "" }}
{{ with .Page.File }}
  {{ $contentPath = .Path }}
{{ else }}
  {{ $contentPath = .Path }}
{{ end }}
{{ $u := urls.Parse .Destination }}
{{ $msg := printf "The %q render hook was unable to resolve the destination %q in %s" $renderHookName $u.String $contentPath }}
{{ $r := "" }}
{{ if $u.IsAbs }}
  {{ with resources.GetRemote $u.String }}
    {{ with .Err }}
      {{ if eq $errorLevel "warning" }}
        {{ warnf "%s. See %s" . $contentPath }}
      {{ else if eq $errorLevel "error" }}
        {{ errorf "%s. See %s" . $contentPath }}
      {{ end }}
    {{ else }}
      {{ $r = . }}
    {{ end }}
  {{ else }}
    {{ if eq $errorLevel "warning" }}
      {{ warnf $msg }}
    {{ else if eq $errorLevel "error" }}
      {{ errorf $msg }}
    {{ end }}
  {{ end }}
{{ else }}
  {{ with .Page.Resources.Get (strings.TrimPrefix "./" $u.Path) }}
    {{ $r = . }}
  {{ else }}
    {{ with (and (ne .Page.BundleType "leaf") (.Page.CurrentSection.Resources.Get (strings.TrimPrefix "./" $u.Path))) }}
      {{ $r = . }}
    {{ else }}
      {{ with resources.Get (printf "resources/%s" $u.Path) }}
        {{ $r = . }}
      {{ else }}
        {{ if eq $errorLevel "warning" }}
          {{ warnf $msg }}
        {{ else if eq $errorLevel "error" }}
          {{ errorf $msg }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ if $r }}
  {{ $id := printf "h-rh-i-%d" .Ordinal }}
  {{ with .Attributes.id }}
    {{ $id = . }}
  {{ end }}
  {{ if ne $r.MediaType.SubType "gif" }}
    {{ $r = $r.Resize (printf "%dx%d webp" $r.Width $r.Height) }}
  {{ end }}
  <img
    src="{{ $r.RelPermalink | absURL }}"
    width="{{ string $r.Width }}"
    height="{{ string $r.Height }}"
    decoding="{{ site.Params.hyas_images.defaults.decoding }}"
    fetchpriority="{{ site.Params.hyas_images.defaults.fetchpriority }}"
    loading="{{ site.Params.hyas_images.defaults.loading }}"
    alt="{{ .PlainText }}"
    {{ with .Title }}title="{{ . }}"{{ end }}
    id="{{ $id }}"
  />
{{ else }}
  <img
    src="{{ .Destination | absURL }}"
    alt="{{ .PlainText }}"
    {{ with .Title }}title="{{ . }}"{{ end }}
  />
  {{ warnf "Image not found: %s" .Destination }}
{{ end }}
